# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  batch: true
  branches:
    include:
      - stage
    exclude:
      - main

pool:
  vmImage: 'ubuntu-latest'

containerRegistry: $(CONTAINER_REGISTRY_CON)
  repository: $(ANALYTICS_REPOSITORY)

variables:
  - containerRegistry:
    value: apimanalytics.azurecr.io
  - repository:
    value: choreo-apim/analytics-api
  - tag:
    value: choreo-apim/analytics-api

steps:
  - template: templates/install-kustomize.yml
  - script: |
      set -eo pipefail
      cd kustomize
      mkdir build
      cd stage
      $KUSTOMIZE edit set image ${{ containerRegistry }}/${{ repository }}=${{ containerRegistry }}/${{ repository }}:${{ tag }}
      echo ${{ containerRegistry }}/${{ repository }}=${{ containerRegistry }}/${{ repository }}:${{ tag }}
    displayName: 'Generate k8s artifacts'

